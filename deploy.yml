---
- hosts: mike_bloy_org
  sudo: true
  gather_facts: true
  roles:
    - role: nginx_site
      website:
        name: mike.bloy.org
        directory: "{{ websites['mike_bloy_org'].directory }}"
        user: "{{ websites['mike_bloy_org'].user }}"
        group: "{{ websites['mike_bloy_org'].group }}"
        groupusers: "{{ websites['mike_bloy_org'].groupusers }}"
        root: "{{ websites['mike_bloy_org'].root }}"
        hostnames:
          - mike.bloy.org
  tasks:
    - name: bundle install
      local_action: command bundle install
      sudo: false
      run_once: true

    - name: build site
      local_action: command bundle exec middleman build
      sudo: false
      run_once: true

    - name: archive site
      local_action: command tar c -z -f build.tar.gz -C build .
      sudo: false
      run_once: true

    - name: copy archive
      unarchive:
        src: build.tar.gz
        dest: "{{ websites['mike_bloy_org'].directory }}"
        owner: "{{ websites['mike_bloy_org'].user }}"
        group: "{{ websites['mike_bloy_org'].group }}"
        mode: g+w
